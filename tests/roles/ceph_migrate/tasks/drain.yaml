# Refresh the client to point to a diff config-home
- name: Get ceph_cli
  ansible.builtin.include_tasks: ceph_cli.yaml
  vars:
    ceph_config_home: "{{ ceph_config_tmp_client_home }}"
    ceph_fsid: "{{ mon_dump.fsid }}"
    ceph_cluster: ceph

# Remove labels from the src node
- name: DRAIN - remove label from the src node
  ansible.builtin.include_tasks: labels.yaml
  vars:
    nodes:
      - "{{ host }}"
    act: "rm"
    labels:
      - "mon"
      - "mgr"
      - "_admin"

- name: DRAIN - Delete the mon running on the current controller node
  delegate_to: "{{ host.split('.')[0] }}.ctlplane"
  become: true
  ansible.builtin.command:
    "{{ ceph_cli }} orch daemon rm mon.{{ host.split('.')[0] }} --force"
  # ignore_errors: true

# Sleep before moving to the next mon
- name: Pause
  ansible.builtin.pause:
    seconds: "{{ ceph_timeout }}"

- name: DRAIN - Drain the host
  become: true
  delegate_to: "{{ host.split('.')[0] }}.ctlplane"
  ansible.builtin.command:
    "{{ ceph_cli }} orch host drain {{ host }}"

# Cleanup leftovers from the controller node
- name: DRAIN - cleanup the host
  delegate_to: "{{ host.split('.')[0] }}.ctlplane"
  become: true
  ansible.builtin.command:
    "cephadm rm-cluster --fsid {{ ceph_fsid }} --force"
  vars:
    ceph_fsid: "{{ mon_dump.fsid }}"
