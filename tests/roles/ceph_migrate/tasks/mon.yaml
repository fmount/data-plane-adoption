- name: Migrate mon
  when: debug | default(true)
  ansible.builtin.debug:
    msg: "Migrate mon: {{ cur_mon }} to node: {{ target_node }}"

- name: Backup data for client purposes
  block:
    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ ceph_config_home }}"
        state: directory

    - name: Backup ceph client data
      become: true
      copy:
        remote_src: true
        src: "/etc/ceph/{{ item }}"
        dest: "{{ ceph_config_home }}"
      loop:
        - ceph.conf
        - ceph.client.admin.keyring

- name: Get ceph_cli
  include_tasks: ceph_cli.yaml
  vars:
    ceph_fsid: "{{ mon_dump.fsid }}"
    ceph_cluster: ceph

# Before draining the current node, migrate the active mgr on a different
# _admin host
- name: Migrate Ceph mgr from the current node if required
  when: debug | default(false)
  block:
    - name: Get the current mgrmap dump
      become: true
      ansible.builtin.shell:
        "{{ ceph_cli }} mgr dump -f json"
      register: mgr

    - name: Load mgr data
      ansible.builtin.set_fact:
        mgr: "{{ mgr.stdout | from_json }}"

    - name: Print active mgr
      when: debug | default(true)
      ansible.builtin.debug:
        msg: "Active mgr: {{ mgr.active_name }}"

    - name: Fail mgr if active in the current node
      become: true
      ansible.builtin.shell:
        "{{ ceph_cli }} mgr fail {{ mgr.active_name }}"
      when:
        - mgr.active_name | length > 0
        - mgr.active_name | regex_search(cur_mon)

# Swap labels between the current node and the target node (that is going to
# host the mon)
- name: Setup Mon/Mgr label to the target node
  ansible.builtin.include_tasks: labels.yaml
  vars:
    nodes:
      - "{{ target_node }}"
    action: "add"
    labels:
      - "mon"
      - "mgr"
      - "_admin"

# Drain and rm the cur_mon from the Ceph cluster
- name: Drain and rm --force the cur_mon host
  when: debug | default(false)
  block:
    - name: Drain the cur_mon host
      become: true
      ansible.builtin.shell:
        "{{ ceph_cli }} orch host drain {{ cur_mon }}"

    - name: rm the cur_mon host from the Ceph cluster
      become: true
      ansible.builtin.shell:
        "{{ ceph_cli }} orch host rm {{ cur_mon }} --force"
      # let's ignore this for now (for idempotency purposes)
      ignore_errors: true

- name: Get current mon IP address
  ansible.builtin.set_fact:
    mon_ipaddr: "{{ mon_ip | split(':') | first | ansible.utils.ipaddr }}"
  vars:
    mon_ip: |-
      {% for mon in mon_dump.mons %}
      {%   if mon.name == cur_mon %}
      {{ mon.addr }}
      {%   endif %}
      {% endfor %}

- name: Move the mon IP Address from {{ cur_mon }} to {{ target_node }}
  become: true
  block:
    - name: Get current mon IP address
      when: debug | default(false)
      ansible.builtin.debug:
        msg: "{{ mon_ipaddr }}"

    - name: Patch os-net-config config and REMOVE the current mon IP address
      delegate_to: "{{ cur_mon }}.ctlplane"
      lineinfile:
        path: "{{ os_net_conf_path }}"
        state: absent
        regexp: '{{ mon_ipaddr }}/24'
        backup: yes
    - name: Refresh os-net-config
      delegate_to: "{{ cur_mon }}.ctlplane"
      ansible.builtin.shell:
        "os-net-config -c /etc/os-net-config/config.yaml"

    - name: Patch os-net-config config and add the mon IP
      delegate_to: "{{ target_node }}.ctlplane"
      when:
        - action is defined
        - action == "add"
      lineinfile:
        dest: "{{ os_net_conf_path }}"
        insertafter: "{{ ceph_storage_net_prefix }}"
        line: "  - ip_netmask: {{ mon_ipaddr }}/24"
        backup: yes
    - name: ping ip address to see if is reachable on the target node
      ansible.builtin.shell:
        "ping -W1 -c 3 {{ mon_ipaddr }}"
      delegate_to: "{{ cur_mon }}.ctlplane"
      register: ping_target_ip

- name: Redeploy mon on the target node
  when: debug | default(true)
  block:
    - name: Print the command that redeploys the mon
      ansible.builtin.debug:
        msg: "{{ ceph_cli }} orch daemon add mon {{ target_node }}:{{ mon_ipaddr }}"

    - name: Redeploy mon on {{ target_node }}
      ansible.builtin.shell:
        "{{ ceph_cli }} orch daemon add mon {{ target_node }}:{{ mon_ipaddr }}"

