# Assign an IP Address on the Storage network to mon[0], that is going to
# be decommissioned: it will be used during the entire migration procedure as
# a client

- name: TMP_CLIENT - Setup a tmp client ip address on the src node
  when:
    - ceph_client_ip is defined
  become: true
  delegate_to: "{{ client_node }}"
  block:
    - name: TMP_CLIENT - Add client ip address on the storage network
      ansible.builtin.template:
        src: ifcfg-ceph.j2
        dest: "{{ net_script_path }}/ifcfg-vlan{{ storage_vlan }}-client"
        mode: "0600"
        force: true
      vars:
        cur_ip: "{{ ceph_client_ip }}"

    # Ensure consistency with os-net-config config
    - name: TMP_CLIENT - Patch os-net-config config
      ansible.builtin.lineinfile:
        dest: "{{ os_net_conf_path }}"
        insertafter: "{{ ceph_storage_net_prefix }}"
        line: "    - ip_netmask: {{ ceph_client_ip }}/24"
        mode: '0666'
        backup: true
    # Enable ip address
    - name: TMP_CLIENT - Enable Ceph client ip address
      ansible.builtin.command:
        "ifup {{ net_script_path }}/ifcfg-vlan{{ storage_vlan }}-client"

# Backup data
- name: Backup data for client purposes
  ansible.builtin.include_tasks: backup.yaml
  vars:
    host: "{{ client_node }}"
  tags:
    - ceph_backup
